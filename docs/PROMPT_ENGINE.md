# PromptEngine æ™ºèƒ½æç¤ºè¯å¼•æ“ - ä½¿ç”¨æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [é…ç½®æ–‡ä»¶è¯´æ˜](#é…ç½®æ–‡ä»¶è¯´æ˜)
4. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
5. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
6. [è¡Œä¸šè¿ç§»æŒ‡å—](#è¡Œä¸šè¿ç§»æŒ‡å—)

---

## åŠŸèƒ½æ¦‚è¿°

PromptEngine æ˜¯ä¸€ä¸ª**å¯é…ç½®ã€å¯æ‰©å±•ã€èƒ½æŒç»­å­¦ä¹ ç”¨æˆ·ä¹ æƒ¯**çš„ä¸ªæ€§åŒ–æç¤ºè¯æ„å»ºç³»ç»Ÿã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **æ™ºèƒ½å­¦ä¹ **ï¼šè‡ªåŠ¨è¿½è¸ªç”¨æˆ·å¸¸ç”¨æœ¯è¯­ï¼ŒåŠ¨æ€è°ƒæ•´æç¤ºè¯
âœ… **é¢‘æ¬¡ç»Ÿè®¡**ï¼šè®°å½•æ¯ä¸ªæœ¯è¯­çš„ä½¿ç”¨é¢‘æ¬¡å’Œæœ€åä½¿ç”¨æ—¶é—´
âœ… **è‡ªåŠ¨æ·˜æ±°**ï¼šç”¨æˆ·è¯åº“è¶…è¿‡å®¹é‡æ—¶ï¼Œè‡ªåŠ¨æ·˜æ±°ä½é¢‘æœ¯è¯­
âœ… **å¯é…ç½®åŒ–**ï¼šæ‰€æœ‰å‚æ•°é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
âœ… **è¡Œä¸šå¯è¿ç§»**ï¼šä»…éœ€ä¿®æ”¹é…ç½®å’Œè¯åº“æ–‡ä»¶å³å¯åˆ‡æ¢è¡Œä¸š

---

## ç³»ç»Ÿæ¶æ„

```
CodeWhisper/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ base_config.json      # å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ base_dict.json         # é€šç”¨æœ¯è¯­åº“ï¼ˆå›ºå®šï¼‰
â”‚   â””â”€â”€ user_dict.json         # ç”¨æˆ·æœ¯è¯­åº“ï¼ˆåŠ¨æ€å­¦ä¹ ï¼‰
â”œâ”€â”€ codewhisper/
â”‚   â”œâ”€â”€ prompt_engine.py       # æç¤ºè¯å¼•æ“æ ¸å¿ƒ
â”‚   â”œâ”€â”€ dict_manager.py        # å­—å…¸ç®¡ç†å™¨
â”‚   â””â”€â”€ transcriber.py         # è½¬å½•å¼•æ“
â””â”€â”€ dictionaries/
    â””â”€â”€ programmer_terms.json  # æœ¯è¯­çº é”™æ€»å­—å…¸
```

---

## é…ç½®æ–‡ä»¶è¯´æ˜

### 1. base_config.json - å…¨å±€é…ç½®

```json
{
  "prompt_prefix": "è®¡ç®—æœºè¡Œä¸šä»ä¸šè€…ï¼š",
  "user_dict_path": "config/user_dict.json",
  "base_dict_path": "config/base_dict.json",
  "max_user_terms": 20,
  "prompt_total_terms": 10,
  "prompt_base_terms": 5,
  "user_term_min_freq": 3
}
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `prompt_prefix` | æç¤ºè¯å‰ç¼€ï¼ˆè¡Œä¸šæ ‡è¯†ï¼‰ | "è®¡ç®—æœºè¡Œä¸šä»ä¸šè€…ï¼š" |
| `prompt_total_terms` | æç¤ºè¯ä¸­æœ¯è¯­æ€»æ•° | 10 |
| `prompt_base_terms` | å›ºå®šé€šç”¨æœ¯è¯­æ•°é‡ | 5 |
| `max_user_terms` | ç”¨æˆ·è¯åº“æœ€å¤§å®¹é‡ | 20 |
| `user_term_min_freq` | æœ¯è¯­è¿›å…¥æç¤ºè¯çš„æœ€ä½é¢‘æ¬¡ | 3 |

### 2. base_dict.json - é€šç”¨æœ¯è¯­åº“

```json
{
  "terms": [
    "ææµ‹",
    "è”è°ƒ",
    "æ’æœŸ",
    "ä¸Šçº¿",
    "å¤ç›˜",
    "æ¥å£",
    "å¹¶å‘",
    "ç¼“å­˜",
    "æ•°æ®åº“",
    "æ—¥å¿—",
    "MySQL",
    "Redis",
    "API",
    "Docker",
    "Git"
  ]
}
```

**ä½œç”¨ï¼š**
- è¡Œä¸šåŸºç¡€æœ¯è¯­ï¼Œå›ºå®šä¸å˜
- æä¾›åŸºç¡€åç½®ï¼Œç¡®ä¿å¸¸è§æœ¯è¯­å§‹ç»ˆå‡ºç°

### 3. user_dict.json - ç”¨æˆ·æœ¯è¯­åº“

```json
{
  "terms": [
    {
      "term": "Redis",
      "freq": 12,
      "last_used": "2025-12-06T18:30:00"
    },
    {
      "term": "Dubbo",
      "freq": 8,
      "last_used": "2025-12-06T18:32:15"
    }
  ]
}
```

**ç‰¹ç‚¹ï¼š**
- è‡ªåŠ¨å­¦ä¹ ï¼Œéšä½¿ç”¨å¢é•¿
- æŒ‰é¢‘æ¬¡å’Œæ—¶é—´æ’åº
- è¶…è¿‡å®¹é‡è‡ªåŠ¨æ·˜æ±°ä½é¢‘è¯

---

## å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·è¯´è¯ â†’ Whisperè½¬å½• â†’ æœ¯è¯­ä¿®æ­£ â†’ æ£€æµ‹æœ¯è¯­ â†’ æ›´æ–°ç”¨æˆ·è¯åº“ â†’ é‡å»ºæç¤ºè¯
   â†‘                                                           â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸‹æ¬¡è½¬å½•ä½¿ç”¨æ–°æç¤ºè¯ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†æ­¥éª¤

**1. ç¨‹åºå¯åŠ¨**
```python
# åŠ è½½é…ç½®å’Œè¯åº“
engine = PromptEngine()
# æ„å»ºåˆå§‹æç¤ºè¯
prompt = engine.build_prompt()
# ç»“æœï¼šè®¡ç®—æœºè¡Œä¸šä»ä¸šè€…ï¼šææµ‹ã€è”è°ƒã€æ’æœŸã€ä¸Šçº¿ã€å¤ç›˜ã€æ¥å£ã€å¹¶å‘ã€ç¼“å­˜ã€æ•°æ®åº“ã€æ—¥å¿—ã€‚
```

**2. è½¬å½•å‰**
```python
# å°†æç¤ºè¯ä¼ ç»™ Whisper
result = model.transcribe(
    audio_file,
    initial_prompt=prompt  # â† æ™ºèƒ½æç¤ºè¯
)
```

**3. è½¬å½•å**
```python
# ä¿®æ­£æœ¯è¯­
text = dict_manager.fix_text(result["text"])

# æ£€æµ‹ç”¨æˆ·ä½¿ç”¨çš„æœ¯è¯­
detected_terms = dict_manager.get_detected_terms_from_corrections()
# ç¤ºä¾‹ï¼š{"Redis", "MySQL", "Docker"}

# æ›´æ–°ç”¨æˆ·è¯åº“
engine.update_user_terms(detected_terms)
```

**4. å­¦ä¹ è¿‡ç¨‹**
```python
# ç¬¬1æ¬¡æåˆ° "Redis" â†’ freq=1
# ç¬¬2æ¬¡æåˆ° "Redis" â†’ freq=2
# ç¬¬3æ¬¡æåˆ° "Redis" â†’ freq=3 âœ“ è¾¾åˆ°é˜ˆå€¼ï¼
# â†’ "Redis" è¿›å…¥æç¤ºè¯
```

**5. æç¤ºè¯è¿›åŒ–**
```
åˆå§‹ï¼šè®¡ç®—æœºè¡Œä¸šä»ä¸šè€…ï¼šææµ‹ã€è”è°ƒã€æ’æœŸã€ä¸Šçº¿ã€å¤ç›˜ã€æ¥å£ã€å¹¶å‘ã€ç¼“å­˜ã€æ•°æ®åº“ã€æ—¥å¿—ã€‚
     â†“ (ç”¨æˆ·ç»å¸¸è¯´ Redisã€Dubbo)
è¿›åŒ–ï¼šè®¡ç®—æœºè¡Œä¸šä»ä¸šè€…ï¼šææµ‹ã€è”è°ƒã€æ’æœŸã€ä¸Šçº¿ã€å¤ç›˜ã€Redisã€Dubboã€æ¥å£ã€å¹¶å‘ã€ç¼“å­˜ã€‚
```

---

## ä½¿ç”¨ç¤ºä¾‹

### æŸ¥çœ‹å½“å‰çŠ¶æ€

```bash
python cli.py --info
```

è¾“å‡ºï¼š
```
æ™ºèƒ½æç¤ºè¯å¼•æ“ï¼š
  é€šç”¨æœ¯è¯­æ•°   : 15 æ¡
  ç”¨æˆ·æœ¯è¯­æ•°   : 4 æ¡
  æœ‰æ•ˆæœ¯è¯­æ•°   : 2 æ¡

å½“å‰æç¤ºè¯ï¼š
  è®¡ç®—æœºè¡Œä¸šä»ä¸šè€…ï¼šææµ‹ã€è”è°ƒã€æ’æœŸã€ä¸Šçº¿ã€å¤ç›˜ã€Redisã€Dubboã€æ¥å£ã€å¹¶å‘ã€ç¼“å­˜ã€‚
```

### æµ‹è¯•å­¦ä¹ åŠŸèƒ½

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
python test_prompt_engine.py
```

### æ‰‹åŠ¨æŸ¥çœ‹ç”¨æˆ·è¯åº“

```bash
cat config/user_dict.json
```

---

## è¡Œä¸šè¿ç§»æŒ‡å—

### åœºæ™¯ï¼šä»"è®¡ç®—æœºè¡Œä¸š"è¿ç§»åˆ°"åŒ»ç–—è¡Œä¸š"

**æ­¥éª¤ 1ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶**

ç¼–è¾‘ `config/base_config.json`ï¼š
```json
{
  "prompt_prefix": "åŒ»ç–—è¡Œä¸šä»ä¸šè€…ï¼š",
  "prompt_total_terms": 10,
  "prompt_base_terms": 5,
  "max_user_terms": 20,
  "user_term_min_freq": 3
}
```

**æ­¥éª¤ 2ï¼šæ›´æ–°é€šç”¨æœ¯è¯­åº“**

ç¼–è¾‘ `config/base_dict.json`ï¼š
```json
{
  "terms": [
    "ç—…å†",
    "è¯Šæ–­",
    "å¤„æ–¹",
    "ä¼šè¯Š",
    "æŸ¥æˆ¿",
    "æ‰‹æœ¯",
    "CT",
    "æ ¸ç£å…±æŒ¯",
    "å¿ƒç”µå›¾",
    "è¡€å‹",
    "è¡€ç³–",
    "åŒ»å˜±",
    "æŠ¤ç†",
    "ICU",
    "æ€¥è¯Š"
  ]
}
```

**æ­¥éª¤ 3ï¼šæ›´æ–°æ€»å­—å…¸**

åœ¨ `dictionaries/` ä¸‹åˆ›å»º `medical_terms.json`ï¼š
```json
{
  "version": "0.1.0",
  "description": "åŒ»ç–—æœ¯è¯­å­—å…¸",
  "categories": {
    "diagnosis": {
      "name": "è¯Šæ–­æœ¯è¯­",
      "terms": {
        "CT": {
          "correct": "CT",
          "variants": [{"wrong": "è¥¿æ"}]
        },
        "æ ¸ç£å…±æŒ¯": {
          "correct": "æ ¸ç£å…±æŒ¯",
          "variants": [{"wrong": "å’Œæ¬¡å…±æŒ¯"}]
        }
      }
    }
  }
}
```

**æ­¥éª¤ 4ï¼šé‡å¯ç¨‹åº**

æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œç›´æ¥è¿è¡Œï¼š
```bash
python cli.py --info
```

è¾“å‡ºï¼š
```
å½“å‰æç¤ºè¯ï¼š
  åŒ»ç–—è¡Œä¸šä»ä¸šè€…ï¼šç—…å†ã€è¯Šæ–­ã€å¤„æ–¹ã€ä¼šè¯Šã€æŸ¥æˆ¿ã€æ‰‹æœ¯ã€CTã€æ ¸ç£å…±æŒ¯ã€å¿ƒç”µå›¾ã€è¡€å‹ã€‚
```

---

## æŠ€æœ¯ç»†èŠ‚

### æç¤ºè¯æ„å»ºç®—æ³•ï¼ˆ5+5ç­–ç•¥ï¼‰

```python
def build_prompt():
    # 1. ä» base_dict å–å‰ 5 ä¸ªé€šç”¨æœ¯è¯­
    base_terms = base_dict[:5]

    # 2. ä» user_dict å–é«˜é¢‘æœ¯è¯­ï¼ˆfreq >= 3ï¼‰
    qualified_terms = [t for t in user_dict if t.freq >= 3]
    sorted_terms = sorted(qualified_terms, key=lambda x: (x.freq, x.last_used), reverse=True)
    user_terms = sorted_terms[:5]

    # 3. å¦‚æœä¸è¶³ï¼Œç”¨ base_dict è¡¥é½
    if len(user_terms) < 5:
        additional = base_dict[5:10]

    # 4. æ‹¼æ¥
    return f"{prefix}{term1}ã€{term2}ã€...ã€{term10}ã€‚"
```

### ç”¨æˆ·è¯åº“ç»´æŠ¤é€»è¾‘

```python
def maintain_user_dict():
    # å®¹é‡ä¸Šé™ï¼š20
    if len(user_dict) > 20:
        # æŒ‰ freq DESC, last_used DESC æ’åº
        sorted_terms = sorted(user_dict, key=lambda x: (x.freq, x.last_used), reverse=True)
        # ä¿ç•™å‰ 20 ä¸ª
        user_dict = sorted_terms[:20]
```

---

## å¸¸è§é—®é¢˜

**Q1: æç¤ºè¯ä»€ä¹ˆæ—¶å€™æ›´æ–°ï¼Ÿ**
A: æ¯æ¬¡è½¬å½•åï¼Œå¦‚æœæ£€æµ‹åˆ°æ–°æœ¯è¯­æˆ–é¢‘æ¬¡å˜åŒ–ï¼Œç«‹å³æ›´æ–°ã€‚ä¸‹æ¬¡è½¬å½•ä½¿ç”¨æ–°æç¤ºè¯ã€‚

**Q2: å¦‚ä½•é‡ç½®ç”¨æˆ·è¯åº“ï¼Ÿ**
A: æ¸…ç©º `config/user_dict.json`ï¼š
```bash
echo '{"terms": []}' > config/user_dict.json
```

**Q3: ä¸ºä»€ä¹ˆæŸä¸ªæœ¯è¯­å‡ºç°äº† 5 æ¬¡è¿˜æ²¡è¿›å…¥æç¤ºè¯ï¼Ÿ**
A: æ£€æŸ¥é…ç½®ä¸­çš„ `user_term_min_freq`ï¼Œé»˜è®¤æ˜¯ 3ã€‚å¦‚æœæç¤ºè¯å·²æ»¡ï¼Œå¯èƒ½è¢«å…¶ä»–é«˜é¢‘æœ¯è¯­å æ®ã€‚

**Q4: å¯ä»¥æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·æœ¯è¯­å—ï¼Ÿ**
A: å¯ä»¥ç›´æ¥ç¼–è¾‘ `config/user_dict.json`ï¼Œæ·»åŠ æœ¯è¯­å’Œé¢‘æ¬¡ã€‚

---

## æ€»ç»“

PromptEngine å®ç°äº†ï¼š
- âœ… å¯é…ç½®ï¼šæ‰€æœ‰å‚æ•°é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶
- âœ… å¯æ‰©å±•ï¼šæ”¯æŒä»»æ„è¡Œä¸šè¿ç§»
- âœ… å¯å­¦ä¹ ï¼šè‡ªåŠ¨è¿½è¸ªç”¨æˆ·ä¹ æƒ¯
- âœ… å¯ç»´æŠ¤ï¼šè‡ªåŠ¨æ·˜æ±°ä½é¢‘æœ¯è¯­

**ä¸€å¥è¯æ€»ç»“ï¼š**
> Whisper æç¤ºè¯ç”±ã€Œé…ç½®å‰ç¼€ + 5 ä¸ªå›ºå®šé€šç”¨æœ¯è¯­ + 5 ä¸ªæŒ‰é¢‘æ¬¡æ’åºçš„ä¸ªæ€§æœ¯è¯­ã€ç»„æˆï¼Œç”¨æˆ·ä¸ªæ€§æœ¯è¯­åº“è‡ªåŠ¨å¢é•¿å’Œæ·˜æ±°ï¼Œè¡Œä¸šè¿ç§»ä»…éœ€æ›´æ”¹é…ç½®æ–‡ä»¶å’Œé€šç”¨è¯åº“ã€‚
